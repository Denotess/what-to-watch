<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MovieFinder - Discover Your Next Favorite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Hero Section */
    .hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
      position: relative;
      background:
        radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
    }

    .hero-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .hero h1 {
      font-size: clamp(2.5rem, 8vw, 5rem);
      font-weight: 800;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      letter-spacing: -2px;
    }

    .hero p {
      font-size: clamp(1rem, 3vw, 1.25rem);
      color: rgba(255, 255, 255, 0.7);
      max-width: 600px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }

    .cta-button {
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(168, 85, 247, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 50px rgba(168, 85, 247, 0.6);
    }

    /* Filters Section */
    .filters-section {
      display: none;
      min-height: 100vh;
      padding: 80px 20px 40px;
    }

    .filters-section.active {
      display: block;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 30px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-5px);
    }

    .filters-header {
      text-align: center;
      margin-bottom: 50px;
    }

    .filters-header h2 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      margin-bottom: 10px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .filter-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .filter-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(168, 85, 247, 0.5);
    }

    .filter-card label {
      display: block;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.9);
    }

    .radio-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .radio-group label {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      transition: all 0.3s ease;
      margin: 0;
    }

    .radio-group input[type="radio"] {
      display: none;
    }

    .radio-group input[type="radio"]:checked + span {
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-color: transparent;
    }

    .radio-group label:hover {
      border-color: rgba(168, 85, 247, 0.5);
    }

    select, input[type="range"] {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select:focus, input[type="range"]:focus {
      outline: none;
      border-color: #a855f7;
      background: rgba(255, 255, 255, 0.12);
    }

    select option {
      background: #1a1a2e;
      color: white;
    }

    select[multiple] {
      min-height: 150px;
      padding: 8px;
    }

    input[type="range"] {
      padding: 0;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.2);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(168, 85, 247, 0.5);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 10px rgba(168, 85, 247, 0.5);
    }

    .hint {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .rating-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #a855f7;
    }

    .submit-button {
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(168, 85, 247, 0.4);
      display: block;
      margin: 0 auto;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .submit-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 50px rgba(168, 85, 247, 0.6);
    }

    /* Results Section */
    .results-section {
      padding: 40px 20px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .results-header h3 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
    }

    .show-filters-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .show-filters-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      .results-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px;
      }
    }

    @media (max-width: 480px) {
      .results-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(168, 85, 247, 0.5);
    }

    .poster-wrap {
      position: relative;
      aspect-ratio: 2/3;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }

    .poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .card:hover .poster {
      transform: scale(1.05);
    }

    .card-body {
      padding: 12px;
    }

    .title {
      font-weight: 600;
      font-size: 0.95rem;
      line-height: 1.3;
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .sub {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .load-more-container {
      text-align: center;
      margin: 40px 0;
    }

    .load-more-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 14px 40px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .load-more-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      border-color: #a855f7;
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      margin: 20px 0;
      font-size: 0.95rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      overflow-y: auto;
      animation: fadeIn 0.3s;
    }

    .modal.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      margin: 5% auto;
      border-radius: 20px;
      max-width: 900px;
      width: 95%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.4s;
      overflow: hidden;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      position: relative;
      height: 400px;
      background: linear-gradient(to bottom, transparent 0%, #1a1a2e 100%);
    }

    .modal-backdrop {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0.3;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10;
      color: #000;
    }

    .modal-close:hover {
      background: #fff;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 30px;
      position: relative;
    }

    .modal-title {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 800;
      margin-bottom: 16px;
      line-height: 1.2;
    }

    .modal-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }

    .modal-rating {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .modal-date {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
    }

    .modal-overview {
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.05rem;
      margin-bottom: 24px;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 12px;
      margin-top: 24px;
      background: #000;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .no-video {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      margin-top: 24px;
      font-size: 1.1rem;
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }

      .modal-header {
        height: 300px;
      }

      .modal-body {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Hero Section -->
  <section id="heroSection" class="hero">
    <div class="hero-icon">🎬</div>
    <h1>MovieFinder</h1>
    <p>Discover your next favorite movie with personalized recommendations based on your preferences</p>
    <button class="cta-button" id="findMoviesBtn">Find Movies Now</button>
  </section>

  <!-- Filters Section -->
  <section id="filtersSection" class="filters-section">
    <div class="container">
      <button class="back-button" id="backBtn">← Back to Home</button>

      <div class="filters-header">
        <h2>Customize Your Search</h2>
        <p class="hint">Select your preferences to find the perfect movie</p>
      </div>

      <form id="filtersForm">
        <div class="filters-grid">
          <!-- Type -->
          <div class="filter-card">
            <label>Content Type</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="type" value="movie" checked>
                <span>Movie</span>
              </label>
              <label>
                <input type="radio" name="type" value="tv">
                <span>TV Show</span>
              </label>
            </div>
          </div>

          <!-- Adult -->
          <div class="filter-card">
            <label>Adult Content</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="adult" value="False" checked>
                <span>No</span>
              </label>
              <label>
                <input type="radio" name="adult" value="True">
                <span>Yes</span>
              </label>
            </div>
          </div>

          <!-- Genres -->
          <div class="filter-card">
            <label for="genres">Genres</label>
            <select id="genres" name="genres" multiple></select>
            <div class="hint">Hold Ctrl/Cmd to select multiple</div>
          </div>

          <!-- Languages -->
          <div class="filter-card">
            <label for="languages">Language</label>
            <select id="languages" name="language"></select>
          </div>

          <!-- Rating -->
          <div class="filter-card">
            <label for="rating">Minimum Rating</label>
            <input type="range" id="rating" name="rating" min="0" max="10" step="0.1" value="5">
            <div class="hint">
              <span class="rating-value" id="ratingValue">5.0</span> / 10
            </div>
          </div>

          <!-- Sort -->
          <div class="filter-card">
            <label for="sortBy">Sort By</label>
            <select id="sortBy" name="sortBy">
              <option value="popularity.desc">Popularity ↓</option>
              <option value="popularity.asc">Popularity ↑</option>
              <option value="vote_average.desc">Rating ↓</option>
              <option value="vote_average.asc">Rating ↑</option>
              <option value="release_date.desc">Newest First</option>
              <option value="release_date.asc">Oldest First</option>
            </select>
          </div>
        </div>

        <button type="submit" class="submit-button">Search Movies</button>
      </form>

      <!-- Results Section -->
      <div id="resultsContainer" class="results-section" style="display: none;">
        <div class="results-header">
          <h3 id="resultsTitle">Recommended Movies</h3>
          <button class="show-filters-btn" id="showFiltersBtn">Show Filters</button>
        </div>
        <div class="status" id="status"></div>
        <div class="results-grid" id="results"></div>
        <div class="load-more-container">
          <button class="load-more-btn" id="loadMoreBtn">Load More</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <img id="modalBackdrop" class="modal-backdrop" src="" alt="">
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <h2 id="modalTitle" class="modal-title"></h2>
        <div class="modal-meta">
          <span class="modal-rating">⭐ <span id="modalRating"></span></span>
          <span class="modal-date" id="modalDate"></span>
        </div>
        <p id="modalOverview" class="modal-overview"></p>
        <div id="videoContainer"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>This product uses the TMDB API but is not endorsed by TMDB.</p>
  </footer>

  <script>
    // Elements
    const heroSection = document.getElementById('heroSection');
    const filtersSection = document.getElementById('filtersSection');
    const resultsContainer = document.getElementById('resultsContainer');
    const findMoviesBtn = document.getElementById('findMoviesBtn');
    const backBtn = document.getElementById('backBtn');
    const showFiltersBtn = document.getElementById('showFiltersBtn');
    const form = document.getElementById('filtersForm');
    const genresSelect = document.getElementById('genres');
    const languagesEl = document.getElementById('languages');
    const ratingInput = document.getElementById('rating');
    const ratingLabel = document.getElementById('ratingValue');
    const resultsEl = document.getElementById('results');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const statusEl = document.getElementById('status');
    const resultsTitle = document.getElementById('resultsTitle');

    // Modal elements
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalRating = document.getElementById('modalRating');
    const modalDate = document.getElementById('modalDate');
    const modalOverview = document.getElementById('modalOverview');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const videoContainer = document.getElementById('videoContainer');

    let currentPage = 1;
    let totalPages = 1;

    // Navigation
    findMoviesBtn.addEventListener('click', () => {
      heroSection.style.display = 'none';
      filtersSection.classList.add('active');
    });

    backBtn.addEventListener('click', () => {
      heroSection.style.display = 'flex';
      filtersSection.classList.remove('active');
      resultsContainer.style.display = 'none';
    });

    showFiltersBtn.addEventListener('click', () => {
      resultsContainer.style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Load data
    async function loadGenres(type, preselectIds) {
      const res = await fetch(`/genres?type=${encodeURIComponent(type)}`);
      const data = await res.json();
      const entries = Object.entries(data).sort((a, b) => a[0].localeCompare(b[0]));

      genresSelect.innerHTML = '';
      for (const [name, id] of entries) {
        const opt = document.createElement('option');
        opt.value = String(id);
        opt.textContent = name;
        if (preselectIds && preselectIds.includes(String(id))) opt.selected = true;
        genresSelect.appendChild(opt);
      }
    }

    async function loadLanguages(preselectCode = 'en') {
      const res = await fetch('/languages');
      const data = await res.json();
      data.sort((a, b) => a.english_name.localeCompare(b.english_name));

      languagesEl.innerHTML = '';
      for (const lang of data) {
        const opt = document.createElement('option');
        opt.value = lang.iso_639_1;
        opt.textContent = lang.english_name;
        if (lang.iso_639_1 === preselectCode) opt.selected = true;
        languagesEl.appendChild(opt);
      }
    }

    function getFilters() {
      const type = document.querySelector('input[name="type"]:checked')?.value || 'movie';
      const genres = Array.from(genresSelect.selectedOptions).map(o => o.value).join(',');
      const language = languagesEl.value || 'en';
      const adult = document.querySelector('input[name="adult"]:checked')?.value || 'False';
      const rating = ratingInput.value || '5';
      const sortBy = document.getElementById('sortBy').value || 'popularity.desc';
      return { type, genres, language, adult, rating, sortBy };
    }

    function setStatus(msg) { statusEl.textContent = msg || ''; }

    function toggleLoadMore(show) {
      loadMoreBtn.style.display = show ? 'inline-block' : 'none';
      loadMoreBtn.disabled = !show;
    }

    // Modal
    async function fetchTrailer(id, type) {
      try {
        const res = await fetch(`/videos?id=${id}&type=${type}`);
        const data = await res.json();
        return data.trailer || null;
      } catch (err) {
        console.error('Failed to fetch trailer:', err);
        return null;
      }
    }

    async function openModal(item, type) {
      modalTitle.textContent = item.title || item.name || 'Untitled';
      modalRating.textContent = typeof item.vote_average === 'number' ? item.vote_average.toFixed(1) : 'N/A';
      modalOverview.textContent = item.overview || 'No description available.';

      const dateField = type === 'movie' ? item.release_date : item.first_air_date;
      if (dateField) {
        modalDate.textContent = `📅 ${new Date(dateField).getFullYear()}`;
      } else {
        modalDate.textContent = '';
      }

      if (item.backdrop_path) {
        modalBackdrop.src = `https://image.tmdb.org/t/p/w1280${item.backdrop_path}`;
      } else if (item.poster_path) {
        modalBackdrop.src = `https://image.tmdb.org/t/p/w1280${item.poster_path}`;
      } else {
        modalBackdrop.src = '';
      }

      videoContainer.innerHTML = '<div class="no-video">Loading trailer...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      const trailer = await fetchTrailer(item.id, type);
      if (trailer && trailer.key) {
        videoContainer.innerHTML = `
          <div class="video-container">
            <iframe src="https://www.youtube.com/embed/${trailer.key}"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen></iframe>
          </div>`;
      } else {
        videoContainer.innerHTML = '<div class="no-video">No trailer available</div>';
      }
    }

    function closeModal() {
      modal.classList.remove('active');
      document.body.style.overflow = '';
      videoContainer.innerHTML = '';
    }

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Render results
    function renderResults(items, append = false) {
      if (!append) resultsEl.innerHTML = "";

      const frag = document.createDocumentFragment();
      const currentType = document.querySelector('input[name="type"]:checked')?.value || 'movie';

      for (const it of items) {
        const title = it.title || it.name || 'Untitled';
        const rating = typeof it.vote_average === 'number' ? it.vote_average.toFixed(1) : 'N/A';
        const posterUrl = it.poster_path ? `https://image.tmdb.org/t/p/w342${it.poster_path}` : null;

        const card = document.createElement('div');
        card.className = 'card';
        card.addEventListener('click', () => openModal(it, currentType));

        const posterWrap = document.createElement('div');
        posterWrap.className = 'poster-wrap';

        if (posterUrl) {
          const img = document.createElement('img');
          img.className = 'poster';
          img.loading = 'lazy';
          img.alt = title;
          img.src = posterUrl;
          posterWrap.appendChild(img);
        } else {
          posterWrap.style.display = 'flex';
          posterWrap.style.alignItems = 'center';
          posterWrap.style.justifyContent = 'center';
          posterWrap.style.color = 'rgba(255, 255, 255, 0.3)';
          posterWrap.textContent = 'No Image';
        }

        const body = document.createElement('div');
        body.className = 'card-body';

        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = title;

        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.innerHTML = `⭐ ${rating}`;

        body.appendChild(t);
        body.appendChild(sub);
        card.appendChild(posterWrap);
        card.appendChild(body);
        frag.appendChild(card);
      }

      resultsEl.appendChild(frag);
    }

    // Fetch results
    async function fetchPage(page = 1, append = false) {
      const filters = getFilters();
      const params = new URLSearchParams({ ...filters, page });
      const url = `/discover?${params.toString()}`;

      setStatus('Loading...');
      toggleLoadMore(false);

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        currentPage = Number(data.page || page);
        totalPages = Number(data.totalPages || 1);

        renderResults(data.results || [], append);

        const resultCount = data.results?.length || 0;
        setStatus(
          resultCount === 0 && currentPage === 1
            ? 'No matches found. Try adjusting your filters.'
            : `Showing page ${currentPage} of ${totalPages} (${resultCount} results)`
        );

        toggleLoadMore(currentPage < totalPages);

        const typeLabel = filters.type === 'movie' ? 'Movies' : 'TV Shows';
        resultsTitle.textContent = `Recommended ${typeLabel} (${resultCount} found)`;
      } catch (err) {
        console.error(err);
        setStatus('Failed to load results. Please check your connection and try again.');
        toggleLoadMore(false);
      }
    }

    // Event listeners
    ratingInput.addEventListener('input', () => {
      ratingLabel.textContent = parseFloat(ratingInput.value).toFixed(1);
    });

    document.querySelectorAll('input[name="type"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const currentSelection = Array.from(genresSelect.selectedOptions).map(o => o.value);
        loadGenres(radio.value, currentSelection);
      });
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      currentPage = 1;
      resultsContainer.style.display = 'block';
      window.scrollTo({ top: document.getElementById('resultsContainer').offsetTop - 20, behavior: 'smooth' });
      fetchPage(1, false);
    });

    loadMoreBtn.addEventListener('click', () => {
      if (currentPage < totalPages) {
        fetchPage(currentPage + 1, true);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadLanguages('en');
      loadGenres('movie', []);
    });
  </script>
</body>
</html>